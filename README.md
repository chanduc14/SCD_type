# SCD_type
MERGE INTO dataengineering.plan_ps.dim_supply_replenishment_planning_location_split AS Target USING ( SELECT CONCAT ( target.Group_Of_Country_Identifier,target.Connect_Product_Key_Material_Identifier,target.Location_Identifier,target.Product_Identifier ) AS mergeKey,source.Source_System_Identifier,source.Logical_Deletion_Indicator,source.Source_System_Update_Timestamp,source.Insert_Gmt_Timestamp,source.Load_Job_Number,source.Source_System_Extract_Gmt_Timestamp,source.Update_Gmt_Timestamp,source.zsggocid AS Group_Of_Country_Identifier,source.zsgcpkmat AS Connect_Product_Key_Material_Identifier,source.locid AS Location_Identifier,source.prdid AS Product_Identifier,source.zsgsplit AS Split_Percent,source.Source_File_Name FROM (select * from dataengineering.plan_ps.zsglocationsplit WHERE partition_insert_gmt_timestamp >= date_format('@Insert_Gmt_Timestamp', 'yyyyMMdd') AND Insert_GMT_Timestamp > '@Insert_Gmt_Timestamp') AS source LEFT JOIN dataengineering.plan_ps.dim_supply_replenishment_planning_location_split AS target ON source.zsggocid = target.Group_Of_Country_Identifier AND source.zsgcpkmat = target.Connect_Product_Key_Material_Identifier AND source.locid = target.Location_Identifier AND source.prdid = target.Product_Identifier AND target.Is_Active_Flag IN ('Y','D') UNION SELECT NULL AS mergeKey,source.Source_System_Identifier,source.Logical_Deletion_Indicator,source.Source_System_Update_Timestamp,source.Insert_Gmt_Timestamp,source.Load_Job_Number,source.Source_System_Extract_Gmt_Timestamp,source.Update_Gmt_Timestamp,source.zsggocid AS Group_Of_Country_Identifier,source.zsgcpkmat AS Connect_Product_Key_Material_Identifier,source.locid AS Location_Identifier,source.prdid AS Product_Identifier,source.zsgsplit AS Split_Percent,source.Source_File_Name FROM (select * from dataengineering.plan_ps.zsglocationsplit WHERE partition_insert_gmt_timestamp >= date_format('@Insert_Gmt_Timestamp', 'yyyyMMdd') AND Insert_GMT_Timestamp > '@Insert_Gmt_Timestamp') AS source LEFT JOIN dataengineering.plan_ps.dim_supply_replenishment_planning_location_split AS target ON source.zsggocid = target.Group_Of_Country_Identifier AND source.zsgcpkmat = target.Connect_Product_Key_Material_Identifier AND source.locid = target.Location_Identifier AND source.prdid = target.Product_Identifier AND target.Is_Active_Flag IN ( 'Y','D' ) WHERE ( source.zsgsplit <> target.Split_Percent AND target.Is_Active_Flag = 'Y' ) OR target.Is_Active_Flag = 'D' ) AS source ON CONCAT ( target.Group_Of_Country_Identifier,target.Connect_Product_Key_Material_Identifier,target.Location_Identifier,target.Product_Identifier ) = Source.mergeKey AND target.Is_Active_Flag IN ( 'Y','D' ) WHEN MATCHED AND (source.Split_Percent <> target.Split_Percent) AND Target.Is_Active_Flag = 'Y' THEN UPDATE SET Target.Effective_End_Date = GETDATE(),Target.Update_Gmt_Timestamp = GETDATE(),Target.Is_Active_Flag = 'N',Target.Logical_Deletion_Indicator = 'U' WHEN MATCHED AND (source.Split_Percent = target.Split_Percent) AND Target.Is_Active_Flag = 'Y' THEN UPDATE SET Target.Logical_Deletion_Indicator = 'U',Target.Update_Gmt_Timestamp = GETDATE(),Target.Source_File_Name = Source.Source_File_Name WHEN MATCHED AND Target.Is_Active_Flag = 'D' THEN UPDATE SET Target.Update_Gmt_Timestamp = GETDATE(),Target.Is_Active_Flag = 'N' WHEN NOT MATCHED BY TARGET THEN INSERT ( Source_System_Identifier,Logical_Deletion_Indicator,Source_System_Update_Timestamp,Insert_Gmt_Timestamp,Load_Job_Number,Source_System_Extract_Gmt_Timestamp,Update_Gmt_Timestamp,Group_Of_Country_Identifier,Connect_Product_Key_Material_Identifier,Location_Identifier,Product_Identifier,Split_Percent,Effective_Start_Date,Effective_End_Date,Is_Active_Flag,Business_Primary_key,Source_File_Name) VALUES ( Source.Source_System_Identifier,'I',Source.Source_System_Update_Timestamp,GETDATE(),Source.Load_Job_Number,Source.Source_System_Extract_Gmt_Timestamp,GETDATE(),Source.Group_Of_Country_Identifier,Source.Connect_Product_Key_Material_Identifier,Source.Location_Identifier,Source.Product_Identifier,Source.Split_Percent,Source.Insert_Gmt_Timestamp,'9999-12-31 23:59:59','Y',CONCAT ( source.Group_Of_Country_Identifier ,'-',source.Connect_Product_Key_Material_Identifier ,'-',source.Location_Identifier ,'-',source.Product_Identifier ),Source.Source_File_Name ) WHEN NOT MATCHED BY SOURCE AND Target.Is_Active_Flag = 'Y' THEN UPDATE SET Target.Effective_End_Date = GETDATE(),Target.Update_Gmt_Timestamp = GETDATE(),Target.Is_Active_Flag = 'D',Target.Logical_Deletion_Indicator = 'D'
